---
import Layout from '../layouts/Layout.astro';
import { publications } from "../data/publications";

const venueColors = {
  NeurIPS: "bg-purple-500/20 text-purple-200 border border-purple-500/30",
  ICML: "bg-blue-500/20 text-blue-200 border border-blue-500/30",
  ICLR: "bg-pink-500/20 text-pink-200 border border-pink-500/30",
  CVPR: "bg-red-500/20 text-red-200 border border-red-500/30",
  TMLR: "bg-green-500/20 text-green-200 border border-green-500/30",
} as const;

type VenueKey = keyof typeof venueColors;

function getVenueBadge(venue: string): string | null {
  const match = (Object.keys(venueColors) as VenueKey[]).find((v) =>
    venue.includes(v)
  );
  if (!match) return null;

  return `<span class="inline-block px-2 py-0.5 rounded-full font-medium text-xs ${venueColors[match]}">${match}</span>`;
}
---

<Layout title="Publications | Ryan Lin" description="Academic publications and research work">
  <div class="max-w-4xl mx-auto px-4 sm:px-6">
    <h1 class="text-4xl font-bold mb-12 text-white" data-aos="fade-down">Publications</h1>
    
    <div class="space-y-8">
      {publications.map((pub, index) => {
        const badge = getVenueBadge(pub.venue);
        return (
          <div class="glass-card rounded-2xl p-8 flex flex-col md:flex-row md:items-start md:space-x-8 transition-all duration-300 hover:bg-white/5" 
               data-aos="fade-up" data-aos-delay={index * 100}>
            
            {/* Left: Text Content */}
            <div class="flex-1">
              <h3 class="text-xl font-bold mb-3 text-white leading-tight">{pub.title}</h3>
              <p class="text-slate-400 mb-2">
                {pub.authors.map((author) => (
                  author === "Ryan Y. Lin" ? 
                    <span class="font-bold text-accent-400">{author}</span> : 
                    author
                )).reduce((prev, curr) => [prev, ", ", curr])}
              </p>

              <p class="text-sm text-slate-500 mb-4">
                {pub.venue}, {pub.year}
              </p>

              {/* New Row: Venue Badge */}
              {badge && (
                <div class="mb-4" set:html={badge}></div>
              )}

              <div class="flex space-x-3">
                {pub.links.pdf && (
                  <a 
                    href={pub.links.pdf} 
                    class="p-2 rounded-lg bg-white/5 text-slate-300 hover:text-white hover:bg-accent-600 transition-all duration-300"
                    target="_blank" 
                    rel="noopener noreferrer"
                    title="Open PDF"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" 
                        d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM14 2v6h6" />
                    </svg>
                  </a>
                )}

                {pub.links.url && (
                  <a 
                    href={pub.links.url} 
                    class="p-2 rounded-lg bg-white/5 text-slate-300 hover:text-white hover:bg-accent-600 transition-all duration-300"
                    target="_blank" 
                    rel="noopener noreferrer"
                    title={pub.platform}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" 
                        d="M18 13v6a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3" />
                    </svg>
                  </a>
                )}

                <button
                  class="relative p-2 w-9 h-9 rounded-lg bg-white/5 text-slate-300 hover:text-white hover:bg-accent-600 transition-all duration-300 copy-bibtex"
                  data-bibtex={pub.bibtex}
                  title="Copy BibTeX"
                >
                  <!-- Clipboard icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 icon transition-opacity duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" 
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2H9z" />
                  </svg>

                  <!-- Checkmark overlay (hidden by default) -->
                  <svg xmlns="http://www.w3.org/2000/svg" 
                      class="w-5 h-5 absolute top-2 right-2 text-green-400 opacity-0 scale-75 check transition-all duration-200" 
                      fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
              </div>
            </div>
      
            {/* Right: Preview Image */}
            {pub.preview && (
              <div class="mt-6 md:mt-0 md:w-48 md:flex-shrink-0">
                <img src={pub.preview} alt={`Preview for ${pub.title}`} class="rounded-lg shadow-lg w-full h-auto object-cover border border-white/10" />
              </div>
            )}
          </div>
        );
      })}
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.copy-bibtex').forEach(button => {
      const icon = button.querySelector('.icon');
      const check = button.querySelector('.check');

      button.addEventListener('click', async () => {
        const bibtex = button.getAttribute('data-bibtex');
        try {
          await navigator.clipboard.writeText(bibtex || '');

          // Animate swap
          check.style.opacity = '1';

          setTimeout(() => {
            check.style.opacity = '0';
          }, 1500);
        } catch (err) {
          console.error('Failed to copy:', err);
          alert('Failed to copy BibTeX. Please try again.');
        }
      });
    });
  });
</script>
