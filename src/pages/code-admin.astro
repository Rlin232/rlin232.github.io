---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mission Control">
	<div class="max-w-4xl mx-auto px-4 py-12 relative z-10">
		<div class="text-center mb-12" data-aos="fade-up">
			<h1 class="text-4xl font-bold font-outfit mb-4 text-white">
				Mission Control
			</h1>
			<p class="text-slate-400">
				Manage constraints and monitor game progress.
			</p>
		</div>

		<div id="admin-auth" class="glass-card rounded-2xl p-8 border border-white/10 max-w-md mx-auto">
			<h2 class="text-xl font-bold mb-6">Authentication Required</h2>
			<form id="login-form" class="space-y-4">
				<input 
					type="password" 
					id="admin-password" 
					class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-accent-500"
					placeholder="Enter admin password"
					required
				/>
				<button 
					type="submit"
					id="auth-btn"
					class="w-full bg-accent-600 hover:bg-accent-500 text-white font-bold py-3 rounded-xl transition-all"
				>
					Login
				</button>
			</form>
		</div>

		<div id="admin-content" class="hidden space-y-8">
			<!-- Stats Overview -->
			<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
				<div class="glass-card rounded-2xl p-6 border border-white/10 text-center">
					<p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Remaining Codes</p>
					<p id="stat-remaining" class="text-3xl font-bold font-mono text-accent-400">0</p>
				</div>
				<div class="glass-card rounded-2xl p-6 border border-white/10 text-center">
					<p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Total Eliminated</p>
					<p id="stat-eliminated" class="text-3xl font-bold font-mono text-white">0</p>
				</div>
				<div class="glass-card rounded-2xl p-6 border border-white/10 text-center">
					<p class="text-slate-500 text-xs uppercase tracking-wider mb-1">System Eliminated</p>
					<p id="stat-system" class="text-3xl font-bold font-mono text-amber-400">0</p>
				</div>
			</div>

			<div class="max-w-2xl mx-auto space-y-8">
				<!-- Add Constraint -->
				<div class="glass-card rounded-2xl p-8 border border-white/10">
					<h2 class="text-2xl font-bold font-outfit mb-6">Add Structured Constraint</h2>
					<form id="constraint-form" class="space-y-6">
						<div class="grid grid-cols-1 gap-6">
							<div>
								<label class="block text-sm font-medium text-slate-400 mb-2">Constraint Type</label>
								<select 
									id="type" 
									name="type" 
									required 
									class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-accent-500"
								>
									<option value="digit_is">Digit at position X is Y</option>
									<option value="digit_is_not">Digit at position X is NOT Y</option>
									<option value="unique_digits">Total unique digits is N</option>
									<option value="sum_is">Sum of digits is S</option>
									<option value="custom">Custom Text (No auto-elimination)</option>
								</select>
							</div>
							<div id="params-container" class="grid grid-cols-2 gap-4">
								<!-- Dynamic params based on type -->
							</div>
						</div>

						<div>
							<label class="block text-sm font-medium text-slate-400 mb-2">Display Description</label>
							<textarea 
								id="description" 
								name="description" 
								required 
								class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white h-20"
								placeholder="e.g., The first digit is 6"
							></textarea>
						</div>

						<div class="flex items-center space-x-3">
							<input type="checkbox" id="is_hard" name="is_hard" checked class="w-5 h-5 rounded border-white/10 bg-slate-900 text-accent-500" />
							<label for="is_hard" class="text-slate-300 font-medium cursor-pointer">Hard Constraint (Auto-Eliminate)</label>
						</div>

						<button 
							type="submit" 
							id="submit-constraint-btn"
							class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
						>
							Add Constraint & Eliminate
						</button>
					</form>
					
					<!-- Progress Bar -->
					<div id="batch-progress" class="mt-6 hidden">
						<div class="flex justify-between text-xs text-slate-400 mb-2">
							<span id="batch-status">Processing chunks...</span>
							<span id="batch-percent">0%</span>
						</div>
						<div class="w-full bg-slate-900 rounded-full h-2 overflow-hidden border border-white/5">
							<div id="batch-bar" class="bg-accent-500 h-full w-0 transition-all duration-300"></div>
						</div>
					</div>

					<p id="constraint-message" class="text-sm mt-4 hidden"></p>
				</div>

				<!-- List Constraints -->
				<div class="glass-card rounded-2xl p-8 border border-white/10">
					<h2 class="text-2xl font-bold font-outfit mb-6">Existing Constraints</h2>
					<div id="admin-constraints-list" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
						<!-- Loaded via JS -->
					</div>
				</div>

				<!-- Remaining Possibilities -->
				<div class="glass-card rounded-2xl p-8 border border-white/10">
					<div class="flex justify-between items-center mb-6">
						<h2 class="text-2xl font-bold font-outfit">Remaining Possibilities</h2>
						<button 
							id="refresh-remaining-btn"
							class="bg-accent-600/20 hover:bg-accent-600/30 text-accent-400 text-sm font-bold px-4 py-2 rounded-lg transition-all"
						>
							Calculate Remaining
						</button>
					</div>
					
					<div id="remaining-loading" class="hidden py-8 text-center">
						<div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-accent-500 mb-4"></div>
						<p class="text-slate-500 text-sm">Fetching guesses and calculating...</p>
					</div>

					<div id="remaining-codes-container" class="hidden">
						<div id="remaining-codes-grid" class="grid grid-cols-4 md:grid-cols-6 gap-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar font-mono text-xs text-slate-400">
							<!-- Loaded via JS -->
						</div>
						<p id="remaining-count-msg" class="text-xs text-slate-500 mt-4 text-right"></p>
					</div>

					<div id="remaining-placeholder" class="py-12 text-center border border-dashed border-white/5 rounded-xl">
						<p class="text-slate-600 text-sm italic">Click the button above to see all remaining valid codes.</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const adminAuth = document.getElementById('admin-auth');
	const adminContent = document.getElementById('admin-content');
	const loginForm = document.getElementById('login-form');
	const passwordInput = document.getElementById('admin-password');
	const authBtn = document.getElementById('auth-btn');

	const constraintForm = document.getElementById('constraint-form');
	const typeSelect = document.getElementById('type');
	const paramsContainer = document.getElementById('params-container');
	const constraintsList = document.getElementById('admin-constraints-list');
	const submitBtn = document.getElementById('submit-constraint-btn');

	const refreshRemainingBtn = document.getElementById('refresh-remaining-btn');
	const remainingLoading = document.getElementById('remaining-loading');
	const remainingCodesContainer = document.getElementById('remaining-codes-container');
	const remainingCodesGrid = document.getElementById('remaining-codes-grid');
	const remainingPlaceholder = document.getElementById('remaining-placeholder');
	const remainingCountMsg = document.getElementById('remaining-count-msg');

	const batchProgress = document.getElementById('batch-progress');
	const batchStatus = document.getElementById('batch-status');
	const batchPercent = document.getElementById('batch-percent');
	const batchBar = document.getElementById('batch-bar');

	const statRemaining = document.getElementById('stat-remaining');
	const statEliminated = document.getElementById('stat-eliminated');
	const statSystem = document.getElementById('stat-system');

	let activeConstraints = [];

	let currentPassword = "";

	loginForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const password = passwordInput.value;
		authBtn.disabled = true;
		authBtn.textContent = 'Verifying...';

		const { data: isValid, error } = await supabase.rpc('verify_admin_password', {
			p_password: password
		});

		if (error) {
			alert('Error verifying password: ' + error.message);
			authBtn.disabled = false;
			authBtn.textContent = 'Login';
			return;
		}

		if (isValid) {
			currentPassword = password;
			adminAuth.classList.add('hidden');
			adminContent.classList.remove('hidden');
			fetchAdminData();
		} else {
			alert('Incorrect password');
			authBtn.disabled = false;
			authBtn.textContent = 'Login';
		}
	});

	typeSelect.addEventListener('change', updateParamsUI);

	function updateParamsUI() {
		const type = typeSelect.value;
		let html = '';

		if (type === 'digit_is' || type === 'digit_is_not') {
			html = `
				<div>
					<label class="block text-xs text-slate-500 mb-1">Position (1-6)</label>
					<input type="number" name="pos" min="1" max="6" required class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white" />
				</div>
				<div>
					<label class="block text-xs text-slate-500 mb-1">Digit (0-9)</label>
					<input type="number" name="val" min="0" max="9" required class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white" />
				</div>
			`;
		} else if (type === 'unique_digits') {
			html = `
				<div class="col-span-2">
					<label class="block text-xs text-slate-500 mb-1">Number of Unique Digits</label>
					<input type="number" name="count" min="1" max="6" required class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white" />
				</div>
			`;
		} else if (type === 'sum_is') {
			html = `
				<div class="col-span-2">
					<label class="block text-xs text-slate-500 mb-1">Target Sum</label>
					<input type="number" name="sum" min="0" max="54" required class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white" />
				</div>
			`;
		}

		paramsContainer.innerHTML = html;
	}

	updateParamsUI();

	async function fetchAdminData() {
		// Fetch Constraints
		const { data: constraints, error: cError } = await supabase
			.from('constraints')
			.select('*')
			.order('created_at', { ascending: false });

		if (cError) console.error(cError);
		else {
			activeConstraints = constraints;
			renderAdminConstraints(constraints);
		}

		// Fetch Stats from Guesses table
		const { count: totalCount, error: gError } = await supabase
			.from('guesses')
			.select('*', { count: 'exact', head: true });

		const { count: systemCount, error: sError } = await supabase
			.from('guesses')
			.select('*', { count: 'exact', head: true })
			.eq('guesser_name', 'System (Rule)');

		if (!gError) {
			statEliminated.textContent = totalCount.toLocaleString();
			statRemaining.textContent = (1000000 - totalCount).toLocaleString();
		}
		if (!sError) {
			statSystem.textContent = systemCount.toLocaleString();
		}
	}

	function renderAdminConstraints(constraints) {
		constraintsList.innerHTML = constraints.map(c => `
			<div class="flex justify-between items-center p-4 rounded-xl bg-white/5 border border-white/5">
				<div>
					<div class="text-slate-300">${c.description}</div>
					<div class="text-xs text-slate-500 mt-1">
						Type: ${c.type || 'custom'} | Hard: ${c.is_hard ? 'Yes' : 'No'}
					</div>
				</div>
				<button 
					onclick="deleteConstraint('${c.id}')"
					class="text-red-400 hover:text-red-300 text-sm font-bold"
				>
					Delete
				</button>
			</div>
		`).join('');
	}

	window.deleteConstraint = async (id) => {
		if (!confirm('Are you sure? This will NOT remove the eliminated codes from the database.')) return;
		const { error } = await supabase.rpc('delete_constraint_secure', {
			p_password: currentPassword,
			p_id: id
		});
		if (error) alert(error.message);
		else fetchAdminData();
	};



	refreshRemainingBtn.addEventListener('click', async () => {
		refreshRemainingBtn.disabled = true;
		remainingPlaceholder.classList.add('hidden');
		remainingCodesContainer.classList.add('hidden');
		remainingLoading.classList.remove('hidden');

		try {
			// 1. Fetch remaining codes via optimized RPC
			const displayLimit = 10000;
			const { data: remainingCodes, error } = await supabase.rpc('get_remaining_codes_secure', {
				p_password: currentPassword,
				p_limit: displayLimit
			});

			if (error) throw error;

			// 2. Fetch total remaining count for the message
			const { count: totalCount, error: countError } = await supabase
				.from('guesses')
				.select('*', { count: 'exact', head: true });

			if (countError) throw countError;
			const actualRemaining = 1000000 - totalCount;

			// 3. Render
			remainingCodesGrid.innerHTML = remainingCodes.map(row => `
				<div class="bg-white/5 rounded px-2 py-1 text-center border border-white/5">${row.code}</div>
			`).join('');

			let msg = `Found ${actualRemaining.toLocaleString()} remaining possibilities.`;
			if (actualRemaining > displayLimit) {
				msg += ` (Showing first ${displayLimit.toLocaleString()} to prevent lag)`;
			}
			remainingCountMsg.textContent = msg;
			remainingCodesContainer.classList.remove('hidden');
		} catch (error) {
			console.error(error);
			alert('Error calculating remaining codes: ' + error.message);
			remainingPlaceholder.classList.remove('hidden');
		} finally {
			remainingLoading.classList.add('hidden');
			refreshRemainingBtn.disabled = false;
		}
	});

	constraintForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(constraintForm);
		const type = formData.get('type');
		const description = formData.get('description');
		const is_hard = formData.get('is_hard') === 'on';

		const params = {};
		if (type === 'digit_is' || type === 'digit_is_not') {
			params.pos = parseInt(formData.get('pos'));
			params.val = parseInt(formData.get('val'));
		} else if (type === 'unique_digits') {
			params.count = parseInt(formData.get('count'));
		} else if (type === 'sum_is') {
			params.sum = parseInt(formData.get('sum'));
		}

		submitBtn.disabled = true;
		submitBtn.textContent = 'Starting...';
		const msg = document.getElementById('constraint-message');
		msg.classList.add('hidden');

		try {
			// 1. Save constraint via secure RPC
			const { data: newConstraint, error: cError } = await supabase.rpc('add_constraint_secure', {
				p_password: currentPassword,
				p_type: type,
				p_description: description,
				p_params: params,
				p_is_hard: is_hard
			});

			if (cError) throw cError;

			// 2. If hard constraint, call RPC in chunks
			if (is_hard && type !== 'custom') {
				batchProgress.classList.remove('hidden');
				const chunkSize = 25000;
				const total = 1000000;
				
				for (let i = 0; i < total; i += chunkSize) {
					const start = i;
					const end = Math.min(i + chunkSize - 1, total - 1);
					
					batchStatus.textContent = `Processing codes ${start.toLocaleString()} to ${end.toLocaleString()}...`;
					const percent = Math.round(((i + chunkSize) / total) * 100);
					batchPercent.textContent = `${percent}%`;
					batchBar.style.width = `${percent}%`;

					const { error: rpcError } = await supabase.rpc('eliminate_codes_secure', {
						p_password: currentPassword,
						p_type: type,
						p_params: params,
						p_start: start,
						p_end: end
					});
					
					if (rpcError) throw rpcError;
				}
			}

			msg.textContent = 'Constraint added and codes eliminated in chunks!';
			msg.className = 'text-sm mt-4 text-green-400';
			msg.classList.remove('hidden');
			
			constraintForm.reset();
			updateParamsUI();
			fetchAdminData();
		} catch (error) {
			console.error(error);
			msg.textContent = error.message;
			msg.className = 'text-sm mt-4 text-red-400';
			msg.classList.remove('hidden');
		} finally {
			submitBtn.disabled = false;
			submitBtn.textContent = 'Add Constraint & Eliminate';
			batchProgress.classList.add('hidden');
		}
	});
</script>

<style>
	.custom-scrollbar::-webkit-scrollbar {
		width: 6px;
	}
	.custom-scrollbar::-webkit-scrollbar-track {
		background: transparent;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb {
		background: rgba(255, 255, 255, 0.1);
		border-radius: 3px;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb:hover {
		background: rgba(255, 255, 255, 0.2);
	}
</style>
