---
import Layout from '../layouts/Layout.astro';
---

<Layout title="IMSS: Project Breakpoint">
	<div class="max-w-4xl mx-auto px-4 py-12 relative z-10">
		<div class="text-center mb-12" data-aos="fade-up">
			<h1 class="text-4xl md:text-6xl font-bold font-outfit mb-4 py-2 bg-clip-text text-transparent bg-gradient-to-r from-white via-accent-400 to-accent-200">
				IMSS: Project Breakpoint
			</h1>
			<p class="text-slate-400 text-lg max-w-2xl mx-auto">
				We're cracking the code. Help us find the breakpoint.
			</p>
		</div>

		<!-- Progress Bar Section -->
		<div class="glass-card rounded-2xl p-8 border border-white/10 mb-8" data-aos="fade-up">
			<div class="flex justify-between items-end mb-4">
				<div>
					<h2 class="text-xl font-bold font-outfit text-white">Total Progress</h2>
					<p class="text-slate-500 text-sm">Codes eliminated by guesses and rules</p>
				</div>
				<div class="text-right">
					<span id="progress-percent" class="text-3xl font-bold font-mono text-accent-400">0.00%</span>
					<p id="progress-count" class="text-slate-500 text-xs">0 / 1,000,000</p>
				</div>
			</div>
			<div class="w-full bg-slate-900 rounded-full h-4 overflow-hidden border border-white/5">
				<div id="progress-bar" class="bg-gradient-to-r from-accent-600 to-accent-400 h-full w-0 transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(14,165,233,0.5)]"></div>
			</div>
		</div>

		<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
			<!-- Left Column: Guessing Form -->
			<div class="lg:col-span-2 space-y-8" data-aos="fade-right">
				<div class="glass-card rounded-2xl p-8 border border-white/10">
					<h2 class="text-2xl font-bold font-outfit mb-6 flex items-center">
						<span class="w-8 h-8 rounded-lg bg-accent-500/20 text-accent-400 flex items-center justify-center mr-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
								<path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
							</svg>
						</span>
						Make a Guess
					</h2>
					
					<form id="guess-form" class="space-y-6">
						<div class="space-y-6">
							<div>
								<label for="code" class="block text-sm font-medium text-slate-400 mb-2">6-Digit Code</label>
								<input 
									type="text" 
									id="code" 
									name="code" 
									required 
									pattern="[0-9]{6}"
									maxlength="6"
									class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-4 text-white font-mono text-3xl tracking-widest text-center focus:outline-none focus:ring-2 focus:ring-accent-500/50 focus:border-accent-500 transition-all"
									placeholder="000000"
								/>
							</div>

							<div class="flex items-center space-x-3 p-4 rounded-xl bg-white/5 border border-white/5">
								<input 
									type="checkbox" 
									id="is_correct" 
									name="is_correct" 
									class="w-5 h-5 rounded border-white/10 bg-slate-900 text-accent-500 focus:ring-accent-500/50"
								/>
								<label for="is_correct" class="text-slate-300 font-medium cursor-pointer">I found the correct code!</label>
							</div>

							<div id="name-field" class="hidden animate-fade-in">
								<label for="guesser_name" class="block text-sm font-medium text-slate-400 mb-2">Your Name (to be recorded as the finder)</label>
								<input 
									type="text" 
									id="guesser_name" 
									name="guesser_name" 
									class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-accent-500/50 focus:border-accent-500 transition-all"
									placeholder="Enter your name"
								/>
							</div>
						</div>
						
						<button 
							type="submit" 
							id="submit-btn"
							class="w-full bg-gradient-to-r from-accent-600 to-accent-500 hover:from-accent-500 hover:to-accent-400 text-white font-bold py-4 rounded-xl shadow-lg shadow-accent-500/20 transition-all duration-300 transform hover:-translate-y-1 active:translate-y-0"
						>
							Submit Attempt
						</button>
						<p id="form-message" class="text-center text-sm mt-4 hidden"></p>
					</form>
				</div>

				<div class="glass-card rounded-2xl p-8 border border-white/10 bg-accent-500/5">
					<p class="text-slate-400 text-sm text-center italic">
						"Every guess is recorded. If a code has already been guessed or violates known constraints, it will be rejected."
					</p>
				</div>
			</div>

			<!-- Right Column: Constraints -->
			<div class="space-y-8" data-aos="fade-left">
				<div class="glass-card rounded-2xl p-8 border border-white/10">
					<h2 class="text-2xl font-bold font-outfit mb-6 flex items-center">
						<span class="w-8 h-8 rounded-lg bg-amber-500/20 text-amber-400 flex items-center justify-center mr-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
								<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
							</svg>
						</span>
						Known Constraints
					</h2>
					<div id="constraints-list" class="space-y-4">
						<div class="text-slate-500 text-center py-4">No constraints known yet.</div>
					</div>
				</div>

				<div class="glass-card rounded-2xl p-8 border border-white/10">
					<h3 class="text-lg font-bold font-outfit mb-4">Stats</h3>
					<div class="space-y-4">
						<div class="flex justify-between items-center">
							<span class="text-slate-400 text-sm">Total Eliminated</span>
							<span id="stat-total" class="text-white font-mono font-bold">0</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Success Modal -->
	<div id="success-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden">
		<div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm"></div>
		<div class="glass-card rounded-3xl p-12 border border-accent-500/30 max-w-lg w-full relative z-10 text-center shadow-2xl shadow-accent-500/20">
			<div class="w-20 h-20 rounded-full bg-accent-500 flex items-center justify-center mx-auto mb-6 animate-bounce">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" viewBox="0 0 20 20" fill="currentColor">
					<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
				</svg>
			</div>
			<h2 class="text-3xl font-bold font-outfit mb-4 text-white">Code Cracked!</h2>
			<p id="success-message" class="text-slate-300 text-lg mb-8"></p>
			<button 
				onclick="document.getElementById('success-modal').classList.add('hidden')"
				class="bg-white text-slate-950 font-bold px-8 py-3 rounded-xl hover:bg-slate-200 transition-colors"
			>
				Close
			</button>
		</div>
	</div>
</Layout>

<script>
	import { supabase } from '../lib/supabase';

	const guessForm = document.getElementById('guess-form');
	const isCorrectCheckbox = document.getElementById('is_correct');
	const nameField = document.getElementById('name-field');
	const guesserNameInput = document.getElementById('guesser_name');
	const constraintsList = document.getElementById('constraints-list');
	const statTotal = document.getElementById('stat-total');
	const progressPercentEl = document.getElementById('progress-percent');
	const progressCountEl = document.getElementById('progress-count');
	const progressBar = document.getElementById('progress-bar');
	const formMessage = document.getElementById('form-message');
	const submitBtn = document.getElementById('submit-btn');
	const successModal = document.getElementById('success-modal');
	const successMessage = document.getElementById('success-message');

	let activeConstraints = [];

	// Toggle name field visibility
	isCorrectCheckbox.addEventListener('change', (e) => {
		if (e.target.checked) {
			nameField.classList.remove('hidden');
			guesserNameInput.required = true;
		} else {
			nameField.classList.add('hidden');
			guesserNameInput.required = false;
		}
	});

	async function fetchData() {
		// Fetch Constraints
		const { data: constraints, error: cError } = await supabase
			.from('constraints')
			.select('*')
			.order('created_at', { ascending: true });

		if (cError) console.error(cError);
		else {
			activeConstraints = constraints;
			renderConstraints(constraints);
		}

		// Fetch Progress (Row count is the source of truth)
		const { count, error: gError } = await supabase
			.from('guesses')
			.select('*', { count: 'exact', head: true });

		if (gError) console.error(gError);
		else {
			updateProgressUI(count);
		}
	}

	function updateProgressUI(count) {
		const percent = (count / 1000000) * 100;
		progressPercentEl.textContent = `${percent.toFixed(2)}%`;
		progressCountEl.textContent = `${count.toLocaleString()} / 1,000,000`;
		progressBar.style.width = `${percent}%`;
		statTotal.textContent = count.toLocaleString();
	}

	function checkCode(codeStr, constraints) {
		const digits = codeStr.split('').map(Number);
		for (const c of constraints) {
			if (!c.is_hard || !c.type) continue;
			const p = c.params;
			if (c.type === 'digit_is') {
				if (digits[p.pos - 1] !== p.val) return { violated: true, description: c.description };
			} else if (c.type === 'digit_is_not') {
				if (digits[p.pos - 1] === p.val) return { violated: true, description: c.description };
			} else if (c.type === 'unique_digits') {
				if (new Set(digits).size !== p.count) return { violated: true, description: c.description };
			} else if (c.type === 'sum_is') {
				if (digits.reduce((a, b) => a + b, 0) !== p.sum) return { violated: true, description: c.description };
			}
		}
		return { violated: false };
	}

	function renderConstraints(constraints) {
		if (constraints.length === 0) {
			constraintsList.innerHTML = '<div class="text-slate-500 text-center py-4">No constraints known yet.</div>';
			return;
		}

		constraintsList.innerHTML = constraints.map(c => `
			<div class="p-4 rounded-xl ${c.is_hard ? 'bg-amber-500/10 border-amber-500/20 text-amber-200' : 'bg-white/5 border-white/10 text-slate-300'} border text-sm">
				${c.description}
				${c.is_hard ? '<span class="block text-[10px] uppercase tracking-wider opacity-50 mt-1">Hard Constraint</span>' : ''}
			</div>
		`).join('');
	}

	guessForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(guessForm);
		const code = formData.get('code');
		const isCorrect = formData.get('is_correct') === 'on';
		const guesser_name = formData.get('guesser_name');

		submitBtn.disabled = true;
		submitBtn.textContent = 'Checking...';
		formMessage.classList.add('hidden');

		try {
			// 1. Check if violates hard constraints (Immediate feedback)
			const checkResult = checkCode(code, activeConstraints);
			if (checkResult.violated) {
				showMessage(`This code is already eliminated by: "${checkResult.description}"`, 'error');
				return;
			}

			// 2. Check if already in DB
			const { data: existing } = await supabase
				.from('guesses')
				.select('id')
				.eq('code', code)
				.maybeSingle();

			if (existing) {
				if (isCorrect) {
					successMessage.textContent = `Congratulations ${guesser_name}! You found the code: ${code}`;
					successModal.classList.remove('hidden');
				} else {
					showMessage('Attempt recorded. That code is now off the list!', 'info');
				}
				guessForm.reset();
				nameField.classList.add('hidden');
				return;
			}

			// 3. Insert guess
			const { error: insertError } = await supabase
				.from('guesses')
				.insert([{ 
					code, 
					guesser_name: isCorrect ? guesser_name : null, 
					is_correct: isCorrect 
				}]);

			if (insertError) throw insertError;

			if (isCorrect) {
				successMessage.textContent = `Congratulations ${guesser_name}! You found the code: ${code}`;
				successModal.classList.remove('hidden');
			} else {
				showMessage('Attempt recorded. That code is now off the list!', 'info');
			}

			guessForm.reset();
			nameField.classList.add('hidden');
			fetchData();
		} catch (error) {
			console.error('Error submitting guess:', error);
			showMessage('Something went wrong. Please try again.', 'error');
		} finally {
			submitBtn.disabled = false;
			submitBtn.textContent = 'Submit Attempt';
		}
	});

	function showMessage(text, type) {
		formMessage.textContent = text;
		formMessage.className = `text-center text-sm mt-4 ${type === 'error' ? 'text-red-400' : 'text-accent-400'}`;
		formMessage.classList.remove('hidden');
	}

	// Initial fetch
	fetchData();

	// Real-time subscriptions
	supabase
		.channel('public:constraints')
		.on('postgres_changes', { event: '*', schema: 'public', table: 'constraints' }, payload => {
			fetchData();
		})
		.subscribe();

	supabase
		.channel('public:guesses')
		.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'guesses' }, payload => {
			fetchData();
		})
		.subscribe();
</script>

<style>
	@keyframes fade-in {
		from { opacity: 0; transform: translateY(-10px); }
		to { opacity: 1; transform: translateY(0); }
	}
	.animate-fade-in {
		animation: fade-in 0.3s ease-out forwards;
	}
</style>
